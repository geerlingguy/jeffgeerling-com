---
name: CI
'on':
  push:
    branches:
      - master
  pull_request:
  schedule:
    - cron: '0 6 * * 0'

jobs:

  install:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        php_version: ['7.3']

    steps:
      - name: Stop the GitHub Actions MySQL instance.
        run: sudo service mysql stop

      - name: Check out code
        uses: actions/checkout@v2

      - name: Set up PHP ${{ matrix.php_version }}
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php_version }}
          tools: symfony

      - name: Install dependencies
        run: composer install

      - name: Start Docker environment
        run: docker-compose up -d

      - name: Wait for MySQL to start.
        run: |
          while ! mysqladmin ping -h"127.0.0.1" -P"3306" --silent; do
            sleep 1
          done

      - name: Start local web server.
        run: symfony serve --no-tls -d

      - name: Install Drupal
        run: >-
          ./vendor/bin/drush site:install minimal
          --db-url="mysql://drupal:drupal@127.0.0.1/drupal"
          --site-name="Jeff Geerling" --existing-config -y

      - name: Test loading the home page.
        run: >
          curl -s http://localhost:8000/ | grep "Jeff Geerling"
